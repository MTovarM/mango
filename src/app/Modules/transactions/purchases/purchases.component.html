<mat-stepper #stepper>
  <!-- Primer paso -->
  <mat-step [stepControl]="dataForm" [editable]="true" color="primary">

    <div fxLayout="column">

      <!-- Formulario -->
      <form [formGroup]="dataForm" (submit)="addProduct()" class="m-form">
        <ng-template matStepLabel>Crear productos</ng-template>
        <section fxLayout="column" fxLayoutGap="8px">

          <div fxLayout="row wrap" fxLayoutAlign="space-between start">
            <mat-form-field appearance="outline" fxFlex="25">
              <mat-label>Fecha</mat-label>
              <input matInput [matDatepicker]="picker" formControlName="date" />
              <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
              <mat-datepicker #picker></mat-datepicker>
            </mat-form-field>


            <div *ngIf="!editing">
              <button mat-button type="submit" [disabled]="dataForm.invalid"><mat-icon>add</mat-icon> Añadir
                producto</button>
            </div>
            <div *ngIf="editing" fxLayout="row" fxLayout="end center">
              <button mat-button [disabled]="dataForm.invalid" (click)="saveEdition()"><mat-icon>edit</mat-icon>
                Guardar
                edición</button>
              <button mat-button [disabled]="dataForm.invalid" (click)="cancelEdition()"><mat-icon>close</mat-icon>
                Cancelar
                edición</button>
            </div>
          </div>

          <div fxLayout="row wrap" fxLayoutAlign="space-between center" fxLayoutGap="9px">
            <mat-form-field appearance="outline" fxFlex="24">
              <mat-label>Código</mat-label>
              <input type="text" matInput formControlName="code" placeholder="Ej. 123456" />
              <mat-error *ngIf="
                    code?.touched && code?.hasError('required')
                  ">
                Ingrese un código
              </mat-error>
              <mat-error *ngIf="code?.hasError('sameCode')">
                El código ya existe
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" fxFlex="auto">
              <mat-label>Nombre</mat-label>
              <input type="text" matInput formControlName="name" placeholder="Ej. Producto" />
              <mat-error *ngIf="
                    name?.touched && name?.hasError('required')
                  ">
                Ingrese un nombre
              </mat-error>
            </mat-form-field>
          </div>

          <mat-form-field appearance="outline">
            <mat-label>Anotaciones</mat-label>
            <textarea type="text" matInput formControlName="annotations"></textarea>
            <!-- <mat-hint align="end">{{annotations.length}} / 50</mat-hint> -->
            <mat-error *ngIf="
                    annotations?.touched &&
                    annotations?.hasError('maxLength')
                  ">
              Debe tener un máximo de 50 caráteres
            </mat-error>
          </mat-form-field>

          <div fxLayout="row wrap" fxLayoutAlign="space-between center" fxLayoutGap="4px">
            <mat-form-field appearance="outline" fxFlex="24">
              <mat-label>Marca</mat-label>
              <input type="text" matInput formControlName="brand" [matAutocomplete]="brandA"/>
              <mat-autocomplete #brandA="matAutocomplete" [displayWith]="typeDisplayFn">
                <mat-option *ngFor="let option of brandFilteredOptions | async" [value]="option">
                  {{option}}
                </mat-option>
              </mat-autocomplete>
              <mat-error *ngIf="
                    brand?.touched && brand?.hasError('required')
                  ">
                Seleccione una marca
              </mat-error>
              <mat-error *ngIf="
                    brand?.touched && brand?.hasError('invalidOption')
                  ">
                Seleccione una marca válida
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" fxFlex="24">
              <mat-label>Tipo</mat-label>
              <input type="text" matInput [matAutocomplete]="typeA" formControlName="type" placeholder="tipo"/>
              <mat-autocomplete #typeA="matAutocomplete" [displayWith]="typeDisplayFn">
                <mat-option *ngFor="let option of typeFilteredOptions | async" [value]="option">
                  {{option}}
                </mat-option>
              </mat-autocomplete>
              <mat-error *ngIf="
                    type?.touched && type?.hasError('required')
                  ">
                Ingrese un tipo
              </mat-error>
              <mat-error *ngIf="
                    type?.touched && type?.hasError('invalidOption')
                  ">
                Ingrese tipo válido
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" fxFlex="24">
              <mat-label>Precio sin IVA</mat-label>
              <input type="number" matInput formControlName="priceWithoutIVA" placeholder="Ej. 12345" />
              <mat-error *ngIf="
                    priceWithoutIVA?.touched &&
                    priceWithoutIVA?.hasError('required')
                  ">
                Ingrese el tipo
              </mat-error>
              <mat-error *ngIf="
                    priceWithoutIVA?.touched &&
                    priceWithoutIVA?.hasError('numberCompare')
                  ">
                Ingrese una cantidad válida
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" fxFlex="24">
              <mat-label>Unidades</mat-label>
              <input type="number" matInput formControlName="units" placeholder="Ej. 1" />
              <mat-error *ngIf="
                    units?.touched && units?.hasError('required')
                  ">
                Ingrese al menos una unidad
              </mat-error>
              <mat-error *ngIf="
                    units?.touched &&
                    units?.hasError('numberCompare')
                  ">
                Ingrese una cantidad válida
              </mat-error>
            </mat-form-field>
          </div>

          <div fxLayout="row wrap" fxLayoutAlign="space-between center" fxLayoutGap="4px">
            <mat-form-field appearance="outline" fxFlex="32">
              <mat-label>Precio de compra</mat-label>
              <input type="text" matInput formControlName="purchasePrice" [value]="purchasePrice?.value | currency" />
            </mat-form-field>

            <mat-form-field appearance="outline" fxFlex="32">
              <mat-label>Precio de venta</mat-label>
              <input type="text" matInput formControlName="salePrice" [value]="salePrice?.value | currency" />
            </mat-form-field>

            <mat-form-field appearance="outline" fxFlex="32">
              <mat-label>Valor invertido</mat-label>
              <input type="text" matInput formControlName="investmentPrice"
                [value]="investmentPrice?.value | currency" />
            </mat-form-field>
          </div>
        </section>
      </form>
    </div>

    <!-- tabla -->
    <div *ngIf="products2Add.length > 0">
      <table mat-table [dataSource]="tableSource" class="mat-elevation-z1">

        <!-- Columna eliminar -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef></th>
          <td mat-cell *matCellDef="let element" fxLayout="row">
            <button mat-icon-button (click)="deleteRow(element)">
              <mat-icon>delete</mat-icon>
            </button>
            <button mat-icon-button (click)="editRow(element)">
              <mat-icon>edit</mat-icon>
            </button>
          </td>
          <td mat-footer-cell *matFooterCellDef></td>
        </ng-container>

        <ng-container *ngFor="let column of headerColumns" [matColumnDef]="column">
          <th mat-header-cell *matHeaderCellDef>{{ columnsName.get(column) }}</th>
          <ng-container *ngIf="column.includes('Price'); else cell">
            <td mat-cell *matCellDef="let element">{{ element[column] | currency }}</td>
            <ng-container *ngIf="column.includes('investmentPrice'); else notFooter">
              <td mat-footer-cell *matFooterCellDef> {{getTotal() | currency}} </td>
            </ng-container>
            <ng-template #notFooter>
              <td mat-footer-cell *matFooterCellDef></td>
            </ng-template>
          </ng-container>
          <ng-template #cell>
            <td mat-cell *matCellDef="let element">{{ element[column] }}</td>
            <ng-container *ngIf="column.includes('code'); else notFooter">
              <td mat-footer-cell *matFooterCellDef><strong>Total</strong></td>
            </ng-container>
            <ng-template #notFooter>
              <td mat-footer-cell *matFooterCellDef></td>
            </ng-template>
          </ng-template>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="columns"></tr>
        <tr mat-row *matRowDef="let row; columns: columns;"></tr>
        <tr mat-footer-row *matFooterRowDef="columns"></tr>
      </table>
    </div>

    <!-- Siguiente paso -->
    <div>
      <button mat-button matStepperNext [disabled]="products2Add.length != 0">
        Finalizar compra<mat-icon>navigate_next</mat-icon>
      </button>
    </div>


  </mat-step>
  <mat-step [stepControl]="providerForm" [editable]="true" color="primary">
    <div fxLayout="column" class="m-form">
      <form [formGroup]="providerForm">
        <ng-template matStepLabel>Finalizar compra</ng-template>
        <div fxLayout="row" fxLayoutAlign="start center" fxLayoutGap="8px">
          <mat-form-field appearance="outline" fxFlex="40">
            <mat-label>Proveedor</mat-label>
            <input matInput type="text" formControlName="providerName" placeholder="Ej. Nombre proveedor" />
            <mat-error *ngIf="
              providerName?.touched && providerName?.hasError('required')
                  ">
              Ingrese este campo
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" fxFlex="40">
            <mat-label>Contacto</mat-label>
            <input matInput type="text" formControlName="providerContact" placeholder="Ej. Contacto proveedor" />
            <mat-error *ngIf="providerContact?.touched && providerContact?.hasError('required')">
              Este campo es requerido
            </mat-error>
          </mat-form-field>
        </div>

        <div>
          <button mat-flat-button color="primary" (click)="savePurchase()" class="save-button"
            [disabled]="providerForm.invalid || products2Add.length == 0">
            <mat-icon>save</mat-icon>Guardar compra
          </button>
        </div>
      </form>
    </div>
  </mat-step>
</mat-stepper>